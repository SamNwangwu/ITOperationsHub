# =============================================================================
# Azure DevOps Pipeline - SPFx Build & Deploy
# =============================================================================
# Builds SPFx solution and deploys to SharePoint Tenant App Catalog
# Uses M365 CLI for deployment (supports client credentials)
# =============================================================================

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - src/*
      - config/*
      - package.json

pr: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: spfx-deployment
  - name: nodeVersion
    value: '18.x'
  - name: solutionName
    value: 'it-ops-homepage.sppkg'

stages:
  # ===========================================
  # BUILD STAGE
  # ===========================================
  - stage: Build
    displayName: 'Build SPFx Solution'
    jobs:
      - job: BuildJob
        displayName: 'Build & Package'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: 'Cache npm packages'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(System.DefaultWorkingDirectory)/node_modules

          - script: npm ci
            displayName: 'Install dependencies'

          - script: gulp bundle --ship
            displayName: 'Bundle solution'

          - script: gulp package-solution --ship
            displayName: 'Package solution'

          - task: PublishPipelineArtifact@1
            displayName: 'Publish artifact'
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)/sharepoint/solution/$(solutionName)'
              artifact: 'spfx-package'
              publishLocation: 'pipeline'

  # ===========================================
  # DEPLOY STAGE
  # ===========================================
  - stage: Deploy
    displayName: 'Deploy to App Catalog'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployJob
        displayName: 'Deploy to SharePoint'
        environment: 'spfx-production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadPipelineArtifact@2
                  displayName: 'Download artifact'
                  inputs:
                    buildType: 'current'
                    artifactName: 'spfx-package'
                    targetPath: '$(Pipeline.Workspace)/package'

                - script: npm install -g @pnp/cli-microsoft365
                  displayName: 'Install M365 CLI'

                - script: |
                    echo "Logging in to Microsoft 365..."
                    m365 login --authType secret --appId "$(CLIENT_ID)" --tenant "$(TENANT_ID)" --secret "$(CLIENT_SECRET)"
                    
                    echo "Deploying to App Catalog..."
                    m365 spo app add --filePath "$(Pipeline.Workspace)/package/$(solutionName)" --appCatalogUrl "$(APP_CATALOG_URL)" --overwrite
                    
                    echo "Publishing app..."
                    m365 spo app deploy --name "$(solutionName)" --appCatalogUrl "$(APP_CATALOG_URL)"
                    
                    echo "âœ… Deployment complete!"
                  displayName: 'Deploy to SharePoint App Catalog'
                  env:
                    CLIENT_SECRET: $(CLIENT_SECRET)