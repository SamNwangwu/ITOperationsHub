# =============================================================================
# Azure DevOps Pipeline - SPFx Build & Deploy (Optimised)
# =============================================================================
# Performance optimisations:
# - Parallel tasks where possible
# - Aggressive caching (npm, PnP module)
# - Skip unnecessary steps
# - Shallow git clone
# - Conditional deployment
# =============================================================================

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - src/*
      - config/*
      - package.json
      - package-lock.json

pr: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: spfx-deployment
  - name: nodeVersion
    value: '18.x'
  - name: solutionName
    value: 'it-ops-homepage.sppkg'
  - name: npm_config_cache
    value: $(Pipeline.Workspace)/.npm
  - name: pnpModulePath
    value: $(Pipeline.Workspace)/.pnp-powershell
  # Disable telemetry for faster builds
  - name: SPFX_TELEMETRY_OPTOUT
    value: '1'
  - name: DISABLE_TELEMETRY
    value: 'true'

stages:
  # ===========================================
  # BUILD STAGE
  # ===========================================
  - stage: Build
    displayName: 'Build'
    jobs:
      - job: BuildJob
        displayName: 'Build & Package'
        steps:
          # Shallow clone - only get latest commit
          - checkout: self
            fetchDepth: 1
            clean: false

          - task: NodeTool@0
            displayName: 'Use Node.js $(nodeVersion)'
            inputs:
              versionSpec: $(nodeVersion)

          # Cache npm packages
          - task: Cache@2
            displayName: 'Cache npm'
            inputs:
              key: 'npm-v2 | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm-v2 | "$(Agent.OS)"
              path: $(npm_config_cache)

          # Cache node_modules directly (faster than npm ci)
          - task: Cache@2
            displayName: 'Cache node_modules'
            inputs:
              key: 'node_modules-v2 | "$(Agent.OS)" | package-lock.json'
              path: $(System.DefaultWorkingDirectory)/node_modules
              cacheHitVar: NODE_MODULES_RESTORED

          # Only run npm ci if node_modules not cached
          - script: npm ci --cache $(npm_config_cache) --prefer-offline
            displayName: 'npm ci'
            condition: ne(variables.NODE_MODULES_RESTORED, 'true')

          # Bundle and package in one step
          - script: |
              gulp bundle --ship
              gulp package-solution --ship
            displayName: 'Build SPFx'

          - publish: $(System.DefaultWorkingDirectory)/sharepoint/solution/$(solutionName)
            displayName: 'Publish artifact'
            artifact: 'spfx-package'

  # ===========================================
  # DEPLOY STAGE
  # ===========================================
  - stage: Deploy
    displayName: 'Deploy'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployJob
        displayName: 'Deploy to SharePoint'
        environment: 'spfx-production'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  displayName: 'Download artifact'
                  artifact: 'spfx-package'

                - task: DownloadSecureFile@1
                  name: certificate
                  displayName: 'Get certificate'
                  inputs:
                    secureFile: 'SPFx-Pipeline.pfx'

                # Cache PnP PowerShell module
                - task: Cache@2
                  displayName: 'Cache PnP.PowerShell'
                  inputs:
                    key: 'pnp-ps-v3 | "2.99"'
                    path: $(pnpModulePath)
                    cacheHitVar: PNP_CACHED

                - task: PowerShell@2
                  displayName: 'Deploy to App Catalog'
                  inputs:
                    targetType: 'inline'
                    pwsh: true
                    script: |
                      $ErrorActionPreference = 'Stop'
                      $modulePath = "$(pnpModulePath)"
                      
                      # Setup module path
                      if (Test-Path "$modulePath/PnP.PowerShell") {
                        Write-Host "✓ PnP.PowerShell cached" -ForegroundColor Green
                      } else {
                        Write-Host "Installing PnP.PowerShell..." -ForegroundColor Cyan
                        New-Item -ItemType Directory -Path $modulePath -Force | Out-Null
                        Save-Module -Name PnP.PowerShell -Path $modulePath -Force
                      }
                      
                      $env:PSModulePath = "$modulePath$([System.IO.Path]::PathSeparator)$env:PSModulePath"
                      Import-Module PnP.PowerShell
                      
                      # Connect
                      $certPassword = ConvertTo-SecureString "$(CERT_PASSWORD)" -AsPlainText -Force
                      Connect-PnPOnline -Url "$(APP_CATALOG_URL)" `
                        -ClientId "$(CLIENT_ID)" `
                        -Tenant "$(TENANT_ID)" `
                        -CertificatePath "$(certificate.secureFilePath)" `
                        -CertificatePassword $certPassword
                      
                      # Deploy
                      $pkg = "$(Pipeline.Workspace)/spfx-package/$(solutionName)"
                      Add-PnPApp -Path $pkg -Scope Tenant -Overwrite -Publish | Out-Null
                      
                      Write-Host "✅ Deployed!" -ForegroundColor Green