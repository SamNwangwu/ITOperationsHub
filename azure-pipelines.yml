# =============================================================================
# Azure DevOps Pipeline - SPFx Build & Deploy
# =============================================================================
# Builds SPFx solution and deploys to SharePoint Tenant App Catalog
# Uses Certificate-based authentication
# =============================================================================

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - src/*
      - config/*
      - package.json

pr: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: spfx-deployment
  - name: nodeVersion
    value: '18.x'
  - name: solutionName
    value: 'it-ops-homepage.sppkg'

stages:
  # ===========================================
  # BUILD STAGE
  # ===========================================
  - stage: Build
    displayName: 'Build SPFx Solution'
    jobs:
      - job: BuildJob
        displayName: 'Build & Package'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: 'Cache npm packages'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(System.DefaultWorkingDirectory)/node_modules

          - script: npm ci
            displayName: 'Install dependencies'

          - script: gulp bundle --ship
            displayName: 'Bundle solution'

          - script: gulp package-solution --ship
            displayName: 'Package solution'

          - task: PublishPipelineArtifact@1
            displayName: 'Publish artifact'
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)/sharepoint/solution/$(solutionName)'
              artifact: 'spfx-package'
              publishLocation: 'pipeline'

  # ===========================================
  # DEPLOY STAGE
  # ===========================================
  - stage: Deploy
    displayName: 'Deploy to App Catalog'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployJob
        displayName: 'Deploy to SharePoint'
        environment: 'spfx-production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadPipelineArtifact@2
                  displayName: 'Download artifact'
                  inputs:
                    buildType: 'current'
                    artifactName: 'spfx-package'
                    targetPath: '$(Pipeline.Workspace)/package'

                - task: DownloadSecureFile@1
                  name: certificate
                  displayName: 'Download certificate'
                  inputs:
                    secureFile: 'SPFx-Pipeline.pfx'

                - task: PowerShell@2
                  displayName: 'Deploy to SharePoint App Catalog'
                  inputs:
                    targetType: 'inline'
                    pwsh: true
                    script: |
                      # Install PnP.PowerShell
                      Write-Host "Installing PnP.PowerShell..." -ForegroundColor Cyan
                      Install-Module -Name PnP.PowerShell -Force -AllowClobber -Scope CurrentUser -SkipPublisherCheck
                      
                      # Connect using certificate
                      Write-Host "Connecting to SharePoint with certificate..." -ForegroundColor Cyan
                      
                      $certPath = "$(certificate.secureFilePath)"
                      $certPassword = ConvertTo-SecureString "$(CERT_PASSWORD)" -AsPlainText -Force
                      
                      Connect-PnPOnline -Url "$(APP_CATALOG_URL)" `
                        -ClientId "$(CLIENT_ID)" `
                        -Tenant "$(TENANT_ID)" `
                        -CertificatePath $certPath `
                        -CertificatePassword $certPassword
                      
                      Write-Host "Connected successfully!" -ForegroundColor Green
                      
                      # Deploy to App Catalog
                      Write-Host "Deploying package to App Catalog..." -ForegroundColor Cyan
                      $packagePath = "$(Pipeline.Workspace)/package/$(solutionName)"
                      
                      Write-Host "Package: $packagePath"
                      Write-Host "App Catalog: $(APP_CATALOG_URL)"
                      
                      # Add and publish the app
                      $app = Add-PnPApp -Path $packagePath -Scope Tenant -Overwrite -Publish
                      
                      Write-Host ""
                      Write-Host "âœ… Deployment complete!" -ForegroundColor Green
                      Write-Host "App ID: $($app.Id)" -ForegroundColor Cyan
                      Write-Host ""
                      Write-Host "The web part is now available in SharePoint."
                      Write-Host "Add it to any page by editing and searching for 'IT Operations Homepage'"