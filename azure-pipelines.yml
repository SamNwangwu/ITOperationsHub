# =============================================================================
# Azure DevOps Pipeline - SPFx Build & Deploy (Optimised)
# =============================================================================

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - src/*
      - config/*
      - package.json
      - package-lock.json

pr: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: spfx-deployment
  - name: nodeVersion
    value: '18.x'
  - name: solutionName
    value: 'it-ops-homepage.sppkg'
  - name: npm_config_cache
    value: $(Pipeline.Workspace)/.npm
  - name: pnpModulePath
    value: $(Pipeline.Workspace)/.pnp-powershell
  - name: SPFX_TELEMETRY_OPTOUT
    value: '1'
  - name: DISABLE_TELEMETRY
    value: 'true'

stages:
  # ===========================================
  # BUILD STAGE
  # ===========================================
  - stage: Build
    displayName: 'Build'
    jobs:
      - job: BuildJob
        displayName: 'Build & Package'
        steps:
          - checkout: self
            fetchDepth: 1
            clean: false

          - task: NodeTool@0
            displayName: 'Use Node.js $(nodeVersion)'
            inputs:
              versionSpec: $(nodeVersion)

          - script: |
              # Use date-based version: 1.0.YYMM.DDHH (all parts under 65535)
              VERSION_MINOR=$(date +%y%m)
              VERSION_PATCH=$(date +%d%H)
              echo "Setting version to 1.0.$VERSION_MINOR.$VERSION_PATCH..."
              sed -i "s/\"version\": \"[0-9]*\.[0-9]*\.[0-9]*\.[0-9]*\"/\"version\": \"1.0.$VERSION_MINOR.$VERSION_PATCH\"/" config/package-solution.json
              grep '"version"' config/package-solution.json
            displayName: 'Auto-increment version'

          - task: Cache@2
            displayName: 'Cache npm'
            inputs:
              key: 'npm-v2 | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm-v2 | "$(Agent.OS)"
              path: $(npm_config_cache)

          - task: Cache@2
            displayName: 'Cache node_modules'
            inputs:
              key: 'node_modules-v2 | "$(Agent.OS)" | package-lock.json'
              path: $(System.DefaultWorkingDirectory)/node_modules
              cacheHitVar: NODE_MODULES_RESTORED

          - script: npm install --legacy-peer-deps --cache $(npm_config_cache) --prefer-offline
            displayName: 'npm install'
            condition: ne(variables.NODE_MODULES_RESTORED, 'true')

          - script: |
              gulp bundle --ship
              gulp package-solution --ship
            displayName: 'Build SPFx'

          - publish: $(System.DefaultWorkingDirectory)/sharepoint/solution/$(solutionName)
            displayName: 'Publish artifact'
            artifact: 'spfx-package'

  # ===========================================
  # DEPLOY STAGE
  # ===========================================
  - stage: Deploy
    displayName: 'Deploy'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployJob
        displayName: 'Deploy to SharePoint'
        environment: 'spfx-production'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  displayName: 'Download artifact'
                  artifact: 'spfx-package'

                - task: DownloadSecureFile@1
                  name: certificate
                  displayName: 'Get certificate'
                  inputs:
                    secureFile: 'SPFx-Pipeline.pfx'

                - task: Cache@2
                  displayName: 'Cache PnP.PowerShell'
                  inputs:
                    key: 'pnp-ps-v3 | "2.99"'
                    path: $(pnpModulePath)
                    cacheHitVar: PNP_CACHED

                - task: PowerShell@2
                  displayName: 'Deploy to App Catalog'
                  inputs:
                    targetType: 'inline'
                    pwsh: true
                    script: |
                      $ErrorActionPreference = 'Continue'
                      $modulePath = "$(pnpModulePath)"
                      
                      # Setup module path
                      if (Test-Path "$modulePath/PnP.PowerShell") {
                        Write-Host "✓ PnP.PowerShell cached" -ForegroundColor Green
                      } else {
                        Write-Host "Installing PnP.PowerShell..." -ForegroundColor Cyan
                        New-Item -ItemType Directory -Path $modulePath -Force | Out-Null
                        Save-Module -Name PnP.PowerShell -Path $modulePath -Force
                      }
                      
                      $env:PSModulePath = "$modulePath$([System.IO.Path]::PathSeparator)$env:PSModulePath"
                      Import-Module PnP.PowerShell
                      
                      # Connect
                      $certPassword = ConvertTo-SecureString "$(CERT_PASSWORD)" -AsPlainText -Force
                      Connect-PnPOnline -Url "$(APP_CATALOG_URL)" `
                        -ClientId "$(CLIENT_ID)" `
                        -Tenant "$(TENANT_ID)" `
                        -CertificatePath "$(certificate.secureFilePath)" `
                        -CertificatePassword $certPassword
                      
                      Write-Host "Connected to SharePoint" -ForegroundColor Green
                      
                      $pkg = "$(Pipeline.Workspace)/spfx-package/$(solutionName)"
                      Write-Host "Package: $pkg" -ForegroundColor Cyan
                      Write-Host "File exists: $(Test-Path $pkg)" -ForegroundColor Cyan
                      
                      # List current apps
                      Write-Host "`nCurrent apps in catalog:" -ForegroundColor Cyan
                      Get-PnPApp -Scope Tenant | Select-Object Title, Id, Deployed | Format-Table
                      
                      # Try to add the app and capture any errors
                      Write-Host "`nAdding app to catalog..." -ForegroundColor Cyan
                      try {
                        $result = Add-PnPApp -Path $pkg -Scope Tenant -Overwrite -Force -ErrorAction Stop
                        Write-Host "Add-PnPApp result: $result" -ForegroundColor Green
                      } catch {
                        Write-Host "Add-PnPApp error: $_" -ForegroundColor Red
                        Write-Host "Error details: $($_.Exception.Message)" -ForegroundColor Red
                      }
                      
                      Start-Sleep -Seconds 3
                      
                      # List apps again to see if it was added
                      Write-Host "`nApps after upload:" -ForegroundColor Cyan
                      $allApps = Get-PnPApp -Scope Tenant
                      $allApps | Select-Object Title, Id, Deployed | Format-Table
                      
                      # Find our app
                      $app = $allApps | Where-Object { $_.Title -like "*it-ops*" -or $_.Title -like "*IT Ops*" -or $_.Title -like "*homepage*" }
                      
                      if ($app) {
                        Write-Host "`nFound app: $($app.Title) - $($app.Id)" -ForegroundColor Green
                        Write-Host "Publishing..." -ForegroundColor Cyan

                        try {
                          Publish-PnPApp -Identity $app.Id -Scope Tenant -SkipFeatureDeployment -Force -ErrorAction Stop
                          Write-Host "✅ Deployed v1.0.0.$(Build.BuildId) to all sites!" -ForegroundColor Green
                        } catch {
                          Write-Host "Publish error: $_" -ForegroundColor Red
                          # Try without SkipFeatureDeployment
                          Publish-PnPApp -Identity $app.Id -Scope Tenant -Force
                          Write-Host "✅ Published (without SkipFeatureDeployment)" -ForegroundColor Yellow
                        }
                      } else {
                        Write-Host "`n⚠️ App not found in catalog after upload" -ForegroundColor Yellow
                        Write-Host "Available apps:" -ForegroundColor Yellow
                        $allApps | ForEach-Object { Write-Host "  - $($_.Title)" }
                        
                        # Exit with error
                        exit 1
                      }